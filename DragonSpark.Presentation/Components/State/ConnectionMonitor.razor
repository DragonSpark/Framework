@using Microsoft.AspNetCore.SignalR.Client
@using DragonSpark.Compose

@inherits DragonSpark.Presentation.Components.ComponentBase

<TimerComponent Interval="@Interval" Updated="@_refresh" Repeat="true" />

@code
{
    EventCallback _refresh;
    protected override void OnInitialized()
    {
        _refresh = Start.A.Callback(OnUpdate).Handle(Exceptions).Get();
        base.OnInitialized();
    }

    [Parameter]
    public HubConnection Subject { get; set; } = default!;

    [Parameter]
    public TimeSpan Interval { get; set; } = TimeSpan.FromSeconds(30);

    async Task OnUpdate()
    {
        switch (Subject.State)
        {
            case HubConnectionState.Disconnected:
                try
                {
                    await Subject.StopAsync();
                    await Subject.StartAsync();
                    await Updated.InvokeAsync().ConfigureAwait(false);
                }
                catch (Exception error)
                {
                    if (Error.HasDelegate)
                    {
                        await Error.InvokeAsync(error).ConfigureAwait(false);
                    }
                    else
                    {
                        Interval = TimeSpan.FromSeconds(90);
                        StateHasChanged();
                        throw;
                    }
                }
                break;
        }
    }

    [Parameter]
    public EventCallback Updated { get; set; }

    [Parameter]
    public EventCallback<Exception> Error { get; set; }
}
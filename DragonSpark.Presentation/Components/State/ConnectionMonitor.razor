@using Microsoft.AspNetCore.SignalR.Client
@using DragonSpark.Compose
@using DragonSpark.Application.Connections.Client
@using DragonSpark.Model.Results

@inject IRestartConnection Restart

@inherits DragonSpark.Presentation.Components.ComponentBase

<TimerComponent Interval="@Interval" Updated="@_refresh" Repeat="true" />

@code
{
    EventCallback _refresh;
    protected override void OnInitialized()
    {
        _refresh = Start.A.Callback(OnUpdate).Handle(Exceptions).Get();
        base.OnInitialized();
    }

    [Parameter]
    public IReceiveConnection Subject { get; set; } = default!;

    [Parameter]
    public TimeSpan Interval { get; set; } = TimeSpan.FromMinutes(5);

    async Task OnUpdate()
    {
        var subject = Subject.Get();
        switch (subject.State)
        {
            case HubConnectionState.Disconnected:
                try
                {
                    await Restart.Get(subject);
                    await Updated.InvokeAsync().ConfigureAwait(false);
                }
                catch (Exception error)
                {
                    Subject.Execute();
                    if (Error.HasDelegate)
                    {
                        await Error.InvokeAsync(error).ConfigureAwait(false);
                    }
                    else
                    {
                        throw;
                    }
                }
                break;
        }
    }

    [Parameter]
    public EventCallback Updated { get; set; }

    [Parameter]
    public EventCallback<Exception> Error { get; set; }
}
@using DragonSpark.Compose
@using DragonSpark.Model.Results
@using DragonSpark.Presentation.Environment.Browser.Document

@inherits DragonSpark.Presentation.Components.ComponentBase

@implements IActivityReceiver
@implements IAsyncDisposable

@inject IFocusedElement Focus

<div class="@Class">
	<fieldset disabled="@Active">
		<CascadingValue TValue="IActivityReceiver" Value="@this" IsFixed="true">
			@ChildContent(ActualReceiver)
		</CascadingValue>
	</fieldset>
</div>

@code
{
	Switch _allowed = new(), _restore = new();

	[Parameter]
	public string CssClass { get; set; } = string.Empty;

	[Parameter]
	public string ActiveStyle { get; set; } = "dragonspark-activity-active";

	[Parameter]
	public object? Receiver { get; set; }

	[Parameter]
	public RenderFragment<object> ChildContent { get; set; } = default!;

	string? Class
	{
		get {
			var start = Active ? ActiveStyle : null;
			var result = $"{start} {CssClass}".Trim().NullIfEmpty();
			return result;
		}
	}

	object ActualReceiver => Receiver ?? this;

	protected override Task OnAfterRenderAsync(bool firstRender)
	{
		_allowed.Up();
		return _restore.Down() ? Focus.Restore.Get().AsTask() : Task.CompletedTask;
	}

	public bool Active { get; private set; }

	bool Update()
	{
		var active = IsActive.Default.Get(ActualReceiver);
		var result = active != Active;
		Active = active;
		return result;
	}

	public async ValueTask Start()
	{
		if (Update())
		{
			if (_allowed)
			{
				await Focus.Store.Get();
			}
			await RefreshState().ConfigureAwait(false);
		}
	}

	public ValueTask Complete()
	{
		_restore.Execute(Update());
		return RefreshState();
	}

	public ValueTask DisposeAsync() => Focus.DisposeAsync();
}
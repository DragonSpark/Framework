@using DragonSpark.Presentation.Connections
@using DragonSpark.Compose
@using DragonSpark.Model
@using DragonSpark.Model.Operations
@using DragonSpark.Application.Connections.Client
@using DragonSpark.Presentation.Components.Content.Rendering
@using System.Diagnostics

@implements IAsyncDisposable

@inject CurrentRenderState State

@code
{
	[Parameter]
	public IReceive Registration { get; set; } = default!;

	[Parameter]
	public IDepending<None> Condition { get; set; } = Is.Always<None>().Operation().Out();

	[Parameter]
	public EventCallback<None> Received { get; set; }

	IReceiver? connection;

	protected override Task OnInitializedAsync()
	{
		switch (State.Get())
		{
			case RenderState.Default:
				break;
			default:
				connection = Registration.Get(OnReceive);
				return connection.Get().AsTask();
		}

		return base.OnInitializedAsync();
	}

	Task OnReceive() => Received.InvokeAsync(None.Default);

	public ValueTask DisposeAsync() => connection?.DisposeAsync() ?? Task.CompletedTask.ToOperation();
}
@using DragonSpark.Compose
@using DragonSpark.Model.Results
@using DragonSpark.Model.Selection

@typeparam T

@ChildContent(_binding)

@code {
    readonly Switch  _requested = new();
    string?          _content;
    Binding<string?> _binding = default!;

    [Parameter]
    public ISelect<T, string> Formatter { get; set; } = default!;

    [Parameter]
    public ISelect<string, T> Parser { get; set; } = default!;

    [Parameter]
    public T? Value { get; set; }

    [Parameter]
    public EventCallback<T?> ValueChanged { get; set; }

    [Parameter]
    public IEqualityComparer<string?> Comparer { get; set; } = StringComparer.CurrentCulture;

    [Parameter]
    public RenderFragment<Binding<string?>> ChildContent { get; set; } = default!;

    protected override void OnInitialized()
    {
        _content = Value is not null ? Formatter.Get(Value) : null;
        _binding = new Binding<string?>(_content, RequestUpdate, Comparer);
        base.OnInitialized();
    }

    void RequestUpdate(string? parameter)
    {
        _content = parameter;
        _requested.Up();
        StateHasChanged();
    }

    protected override Task OnParametersSetAsync()
        => _requested.Down() ? ValueChanged.Invoke(Value = !string.IsNullOrEmpty(_content) ? Parser.Get(_content) : default) : Task.CompletedTask;
}
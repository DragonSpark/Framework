@using DragonSpark.Presentation.Components.Eventing
@using DragonSpark.Application.Entities.Queries.Runtime
@using DragonSpark.Compose
@using NetFabric.Hyperlinq

@typeparam T

@implements IDisposable

<RefreshQueriesMonitor T="T" Topic="@Topic" Updated="@OnUpdate" />

<CascadingValue Value="@Subject">
	@ChildContent
</CascadingValue>

@code {
	readonly ICollection<IRefreshAware> _children = new List<IRefreshAware>();

	IRefreshContainer Subject { get; set; } = default!;

	protected override void OnInitialized()
	{
		base.OnInitialized();
		Subject = new RefreshContainer(_children);
	}

	[Parameter]
	public IQueries<T> Topic { get; set; } = default!;

	[Parameter]
	public RenderFragment ChildContent { get; set; } = default!;

	async Task OnUpdate()
	{
		foreach (var item in _children.AsValueEnumerable())
		{
			await item.Await();
		}
	}

	public void Dispose()
	{
		_children.Clear();
	}
}

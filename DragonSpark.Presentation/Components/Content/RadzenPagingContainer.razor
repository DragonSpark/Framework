@using DragonSpark.Application.Entities.Queries.Runtime
@using DragonSpark.Application.Entities.Queries.Runtime.Shape
@using DragonSpark.Compose
@using DragonSpark.Presentation.Components.Eventing

@typeparam T

@inherits ActiveContentTemplateComponentBase<IRadzenPaging<T>>

@if (Current is null or {IsCompletedSuccessfully : true})
{
	<ContentView Content="@Subject" ChildContent="@ChildContent" NotFoundTemplate="@NotAssignedTemplate" />
}
else if (Current is {IsFaulted : true })
{
	@ExceptionTemplate
}
@*else if (Rendered is not null)
{
	@Rendered
}*@
else
{
	@LoadingTemplate
}


@code
{
	Action<Task> _report = default!;
	protected override ValueTask Initialize()
	{
		_report = Report;
		return base.Initialize();
	}

	[Parameter]
	public IPaging<T>? Content
	{
		get => _content;
		set
		{
			if (_content != value)
			{
				_content = value;
				if (Current is {IsFaulted: true})
				{
					Rendered = null;
				}
				Subject = null;
				Current = null;
			}
		}
	}	IPaging<T>? _content;

	[Parameter]
	public bool IncludeCount { get; set; } = true;

	IRadzenPaging<T>? Subject { get; set; }

	RenderFragment? Rendered { get; set; }

	protected override void OnParametersSet()
	{
		base.OnParametersSet();
		Subject ??= Content != null ? New(Content) : default;
	}

	protected override void OnAfterRender(bool firstRender)
	{
		base.OnAfterRender(firstRender);

		/*if (Current is { IsCompletedSuccessfully: true })
		{
			Rendered ??= Subject is not null ? ChildContent(Subject) : NotAssignedTemplate;
		}*/
	}

	Task? Current { get; set; }

	void Report(Task parameter)
	{
		var update = Current is null;
		Current = parameter;
		if (update)
		{
			StateHasChanged();
		}
	}

	IRadzenPaging<T> New(IPaging<T> content)
	{
		var first = new RadzenPaging<T>(content, IncludeCount);
		var second = new ValidatedRadzenPaging<T>(first);
		var result = new ReportedRadzenPaging<T>(second, _report);
		return result;
	}

}


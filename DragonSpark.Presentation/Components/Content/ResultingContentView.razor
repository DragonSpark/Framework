@typeparam T

@using DragonSpark.Compose
@using DragonSpark.Model.Operations

@inherits DragonSpark.Presentation.Components.Content.Templates.ActiveContentTemplateComponentBase<T>

@if (Subject is null)
{
	@NotFoundTemplate
}
else if (Subject is { IsFaulted : true })
{
	@ExceptionTemplate
}
else if (Fragment != null)
{
	@Fragment
}
else
{
	@LoadingTemplate
}

@code
{
	[Parameter]
	public IResulting<T?>? Content
	{
		get => _content;
		set
		{
			if (_content != value && value is not null)
			{
				_content = value;
				Loaded = false;
				Worker = null;
			}
		}
	}	IResulting<T?>? _content;

	RenderFragment? Fragment { get; set; }

	bool Loaded
	{
		get => _loaded;
		set
		{
			if (_loaded != value)
			{
				_loaded = value;
				if (value)
				{
					var result = Subject.Verify().Result;
					Fragment = result is not null ? ChildContent(result) : NotFoundTemplate;
					StateHasChanged();
				}
			}
		}
	}	bool _loaded;

	protected override void OnParametersSet()
	{
		base.OnParametersSet();
		Worker ??= DetermineSubject();
		Update();
	}

	protected override Task OnParametersSetAsync() => Worker?.Worker ?? base.OnParametersSetAsync();

	ContentWorker<T>? Worker { get; set; }

	Task<T?>? Subject => Worker?.Result;

	ContentWorker<T> DetermineSubject()
	{
		var content = Content ?? Defaulting<T>.Default;
		var result = ContentWorkers<T>.Default.Get(content);
		return result;
	}

	protected override void OnAfterRender(bool firstRender)
	{
		base.OnAfterRender(firstRender);
		Update();
	}

	void Update()
	{
		Loaded |= Subject is { IsCompletedSuccessfully: true };
	}

}
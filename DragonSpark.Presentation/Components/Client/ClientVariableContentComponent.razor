@using DragonSpark.Compose
@using DragonSpark.Model.Results
@using DragonSpark.Presentation.Components.Content.Templates
@using DragonSpark.Presentation.Environment.Browser
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage

@typeparam T

@inherits Components.ComponentBase

@if (_input is null)
{
    @LoadingTemplate
}
else if (_input.Value.Success)
{
    @ChildContent(_input.Value.Value)
}
else
{
    @NotFoundTemplate
}

@code {
    ProtectedBrowserStorageResult<T>? _input;

    [Parameter]
    public required IClientVariable<T> Input { get; set; }

    [Parameter]
    public required RenderFragment<T?> ChildContent { get; set; }

    [Parameter]
    public required Switch? Refresh { get; set; }

    [Parameter]
    public RenderFragment LoadingTemplate { get; set; } = DefaultLoadingTemplate.Default;

    [Parameter]
    public RenderFragment NotFoundTemplate { get; set; } = EmptyContentTemplate.Default;

    [Parameter]
    public EventCallback<ProtectedBrowserStorageResult<T>> Ready { get; set; }

    [CascadingParameter] public required IActivityReceiver Receiver { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || (Refresh?.Down() ?? false))
        {
            _input = await Input.On();
            if (Ready.HasDelegate)
            {
                await Ready.Off(_input.Value);
            }
            else
            {
                StateHasChanged();
            }
        }
    }
}
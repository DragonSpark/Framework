@using DragonSpark.Presentation.Environment.Browser
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using DragonSpark.Compose
@using DragonSpark.Presentation.Components.Interaction

@typeparam T

@ChildContent(Binding)

@code
{
    bool _assigned;

    [Parameter]
    public IClientVariable<T> Store { get; set; } = default!;

    [Parameter]
    public T Value { get; set; } = default!;

    [Parameter]
    public T AssignedValue 
    {
        get => _assignedValue;
        set
        {
            _assignedValue = value;
            _assigned = true;
        }
    }	T _assignedValue = default!;

    [Parameter]
    public EventCallback<T> ValueChanged { get; set; }

    [Parameter]
    public EventCallback<Binding<T>> Loaded { get; set; }

    [Parameter]
    public IEqualityComparer<T> Comparer { get; set; } = EqualityComparer<T>.Default;

    [Parameter]
    public RenderFragment<Binding<T>> ChildContent { get; set; } = default!;

    ProtectedBrowserStorageResult<T>? Result { get; set; }

    protected override void OnInitialized()
    {
        Binding = new Binding<T>(Value, RequestUpdate, Comparer);
        base.OnInitialized();
    }

    void RequestUpdate(T parameter)
    {
        if (Rendered)
        {
            UpdateRequested = true;
            StateHasChanged();
        }
    }

    bool UpdateRequested { get; set; }
    bool Rendered { get; set; }
    Binding<T> Binding { get; set; } = default!;

    protected override async Task OnParametersSetAsync()
    {
        if (UpdateRequested)
        {
            UpdateRequested = false;
            await ValueChanged.InvokeAsync(Value = Binding.Value);
            await Store.Await(Binding.Value);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Result is null)
        {
            Result = await Store.Get();
            if (Result?.Success ?? false)
            {
                Binding.Value = Result.Value.Value ?? AssignedValue ?? Value;
                await Loaded.InvokeAsync(Binding);
                await ValueChanged.InvokeAsync(Value = Binding.Value).ConfigureAwait(false);
            }
            else if (_assigned)
            {
                await ValueChanged.InvokeAsync(Value = Binding.Value = AssignedValue).ConfigureAwait(false);
            }
        }
        Rendered = true;
    }
}
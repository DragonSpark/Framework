@using DragonSpark.Compose
@using DragonSpark.Presentation.Components.Eventing
@using Humanizer

@typeparam T where T : class

@inherits ModelPersistenceComponentBase<T>

@inject ProblemSavingState ProblemSaving
@inject SavedContentMessage Message

<HandlerView T="SaveModelMessage" Received="@Handle" />

@code
{
    [Parameter]
    public required T Model { get; set; }

    [Parameter]
    public EventCallback Saved { get; set; }

    Task Handle(SaveModelMessage message) => message.Subject == Model ? SaveContent() : Task.CompletedTask;

    async Task SaveContent()
    {
        try
        {
            var content = Serializer.Get(Model);
            await Store.On(content);
            Message.Execute(content.Length.Bytes().Humanize());
            await Saved.Off();
        }
        catch (Exception e)
        {
            ProblemSaving.Execute(e);
            await ErrorOccurred.Invoke().Off();
        }
    }
}
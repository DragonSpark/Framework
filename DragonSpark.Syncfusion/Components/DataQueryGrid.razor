@using BlazorPro.BlazorSize
@using DragonSpark.Compose
@using DragonSpark.Model.Operations
@using DragonSpark.Presentation
@using DragonSpark.Presentation.Components.Content.Templates
@using DragonSpark.Presentation.Components.State
@using DragonSpark.SyncfusionRendering.Queries
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Grids

@typeparam T
@inherits DataQueryComponent

<AdaptiveGrid T="T"
	@ref="@_subject"
	FilterType="@FilterType"
	Columns="@Columns"
	AllowPaging="@AllowPaging"
	AllowFiltering="@AllowFiltering"
	AllowSorting="@AllowSorting"
	Breakpoint="@Breakpoint"
	CssClass="@CssClass"
	PageSize="@PageSize"
	LoadingTemplate="@LoadingTemplate"
	@attributes="@AdditionalAttributes">
	<GridTemplates EmptyRecordTemplate="@LoadingTemplate.Accept" />
	<Syncfusion.Blazor.Data.SfDataManager Adaptor="Adaptors.CustomAdaptor">
		<DataRequestCallbackAdaptor Requested="@OnRequest" />
	</Syncfusion.Blazor.Data.SfDataManager>
	@if (ChildContent is not null)
	{
		@ChildContent
	}
</AdaptiveGrid>

@code {
	AdaptiveGrid<T> _subject = default!;

    protected override void OnContentChanged()
    {
        RefreshRequested = Input != null;
    }

    [Parameter]
	public FilterType FilterType { get; set; } = FilterType.Excel;

	[Parameter]
	public RenderFragment Columns { get; set; } = default!;

	[Parameter]
	public string Breakpoint { get; set; } = Breakpoints.SmallUp;

	public Task Refresh() => _subject.Refresh();

	Await<DataManagerRequest, object>? Input { get; set; }

	bool RefreshRequested { get; set; }

	protected override Task OnParametersSetAsync()
	{
		if (RefreshRequested)
		{
			RefreshRequested = false;
			return _subject.Refresh();
		}
		return base.OnParametersSetAsync();
	}

    protected override Await<DataManagerRequest, object> CreateInput()
    {
        return Content.Then().Then().UpdateActivity(Receiver)
                      .Handle(Exceptions, ReportedType ?? GetType(), EmptyDataResult.Default);
    }

}

@using BlazorPro.BlazorSize
@using DragonSpark.Compose
@using DragonSpark.Model.Operations
@using DragonSpark.Presentation
@using DragonSpark.Presentation.Components.Content.Templates
@using DragonSpark.Presentation.Components.State
@using DragonSpark.SyncfusionRendering.Queries
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Grids
@using Action = Syncfusion.Blazor.Grids.Action

@typeparam T
@inherits DataQueryComponent

<AdaptiveGrid T="T"
	@ref="@_subject"
	Id="@Id"
	FilterType="@FilterType"
	Columns="@Columns"
	AllowPaging="@AllowPaging"
	AllowFiltering="@AllowFiltering"
	AllowSorting="@AllowSorting"
	Breakpoint="@Breakpoint"
	CssClass="@CssClass"
	PageSize="@PageSize"
	LoadingTemplate="@LoadingTemplate"
	@attributes="@AdditionalAttributes">

	<GridTemplates EmptyRecordTemplate="@EmptyTemplate" />

	<GridEvents TValue="T" DataBound="OnDataBound" />
	<Syncfusion.Blazor.Data.SfDataManager Adaptor="Adaptors.CustomAdaptor">
		<DataRequestCallbackAdaptor Requested="@OnRequest" />
	</Syncfusion.Blazor.Data.SfDataManager>
	@if (ChildContent is not null)
	{
		@ChildContent
	}
</AdaptiveGrid>

@code {
	AdaptiveGrid<T> _subject = default!;

	protected override void OnInitialized()
	{
		EmptyTemplate = LoadingTemplate.Accept;
		base.OnInitialized();
	}

	protected override void OnContentChanged(Await<DataManagerRequest, object>? parameter)
	{
		RefreshRequested = parameter != null;
	}

	[Parameter]
	public string Id { get; set; } = string.Empty;

	[Parameter]
	public FilterType FilterType { get; set; } = FilterType.Excel;

	[Parameter]
	public RenderFragment Columns { get; set; } = default!;

	[Parameter]
	public string Breakpoint { get; set; } = Breakpoints.SmallUp;

	[Parameter]
	public RenderFragment EmptyElementsTemplate { get; set; } = DefaultEmptyResultTemplate.Default;

	RenderFragment<EmptyRecordTemplateContext>? EmptyTemplate { get; set; }

	public Task Refresh() => _subject.Refresh();

	bool RefreshRequested { get; set; }

	protected override Task OnParametersSetAsync()
	{
		if (RefreshRequested)
		{
			RefreshRequested = false;
			return _subject.Refresh();
		}
		return base.OnParametersSetAsync();
	}

	protected override Await<DataManagerRequest, object> CreateInput()
		=> Content.Then().Then().UpdateActivity(Receiver)
				  .Handle(Exceptions, ReportedType ?? GetType(), EmptyDataResult.Default.Get());

	void OnDataBound()
	{
		EmptyTemplate = EmptyElementsTemplate.Accept;
	}
}